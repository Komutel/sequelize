{
  "version": 3,
  "sources": ["../src/model-manager.js"],
  "sourcesContent": ["'use strict';\r\n\r\nconst Toposort = require('toposort-class');\r\nconst _ = require('lodash');\r\n\r\nexport class ModelManager {\r\n  constructor(sequelize) {\r\n    this.models = [];\r\n    this.sequelize = sequelize;\r\n  }\r\n\r\n  addModel(model) {\r\n    this.models.push(model);\r\n    this.sequelize.models[model.name] = model;\r\n\r\n    return model;\r\n  }\r\n\r\n  removeModel(modelToRemove) {\r\n    this.models = this.models.filter(model => model.name !== modelToRemove.name);\r\n\r\n    delete this.sequelize.models[modelToRemove.name];\r\n  }\r\n\r\n  getModel(against, options) {\r\n    options = _.defaults(options || {}, {\r\n      attribute: 'name',\r\n    });\r\n\r\n    return this.models.find(model => model[options.attribute] === against);\r\n  }\r\n\r\n  get all() {\r\n    return this.models;\r\n  }\r\n\r\n  /**\r\n   * Returns an array that lists every model, sorted in order\r\n   * of foreign key references: The first model is a model that is depended upon,\r\n   * the last model is a model that is not depended upon.\r\n   *\r\n   * If there is a cyclic dependency, this returns null.\r\n   */\r\n  getModelsTopoSortedByForeignKey() {\r\n    const models = new Map();\r\n    const sorter = new Toposort();\r\n\r\n    for (const model of this.models) {\r\n      let deps = [];\r\n      let tableName = model.getTableName();\r\n\r\n      if (_.isObject(tableName)) {\r\n        tableName = `${tableName.schema}.${tableName.tableName}`;\r\n      }\r\n\r\n      models.set(tableName, model);\r\n\r\n      for (const attrName in model.rawAttributes) {\r\n        if (Object.prototype.hasOwnProperty.call(model.rawAttributes, attrName)) {\r\n          const attribute = model.rawAttributes[attrName];\r\n\r\n          if (attribute.references) {\r\n            let dep = attribute.references.model;\r\n\r\n            if (_.isObject(dep)) {\r\n              dep = `${dep.schema}.${dep.tableName}`;\r\n            }\r\n\r\n            deps.push(dep);\r\n          }\r\n        }\r\n      }\r\n\r\n      deps = deps.filter(dep => tableName !== dep);\r\n\r\n      sorter.add(tableName, deps);\r\n    }\r\n\r\n    let sorted;\r\n    try {\r\n      sorted = sorter.sort();\r\n    } catch (error) {\r\n      if (!error.message.startsWith('Cyclic dependency found.')) {\r\n        throw error;\r\n      }\r\n\r\n      return null;\r\n    }\r\n\r\n    return sorted\r\n      .map(modelName => {\r\n        return models.get(modelName);\r\n      })\r\n      .filter(Boolean);\r\n  }\r\n\r\n  /**\r\n   * Iterate over Models in an order suitable for e.g. creating tables.\r\n   * Will take foreign key constraints into account so that dependencies are visited before dependents.\r\n   *\r\n   * @param {Function} iterator method to execute on each model\r\n   * @param {object} options\r\n   * @private\r\n   *\r\n   * @deprecated\r\n   */\r\n  forEachModel(iterator, options) {\r\n    const sortedModels = this.getModelsTopoSortedByForeignKey();\r\n    if (sortedModels == null) {\r\n      throw new Error('Cyclic dependency found.');\r\n    }\r\n\r\n    options = _.defaults(options || {}, {\r\n      reverse: true,\r\n    });\r\n\r\n    if (options.reverse) {\r\n      sortedModels.reverse();\r\n    }\r\n\r\n    for (const model of sortedModels) {\r\n      iterator(model);\r\n    }\r\n  }\r\n}\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,MAAM,WAAW,QAAQ,gBAAgB;AACzC,MAAM,IAAI,QAAQ,QAAQ;AAEnB,MAAM,aAAa;AAAA,EACxB,YAAY,WAAW;AACrB,SAAK,SAAS,CAAC;AACf,SAAK,YAAY;AAAA,EACnB;AAAA,EAEA,SAAS,OAAO;AACd,SAAK,OAAO,KAAK,KAAK;AACtB,SAAK,UAAU,OAAO,MAAM,QAAQ;AAEpC,WAAO;AAAA,EACT;AAAA,EAEA,YAAY,eAAe;AACzB,SAAK,SAAS,KAAK,OAAO,OAAO,WAAS,MAAM,SAAS,cAAc,IAAI;AAE3E,WAAO,KAAK,UAAU,OAAO,cAAc;AAAA,EAC7C;AAAA,EAEA,SAAS,SAAS,SAAS;AACzB,cAAU,EAAE,SAAS,WAAW,CAAC,GAAG;AAAA,MAClC,WAAW;AAAA,IACb,CAAC;AAED,WAAO,KAAK,OAAO,KAAK,WAAS,MAAM,QAAQ,eAAe,OAAO;AAAA,EACvE;AAAA,EAEA,IAAI,MAAM;AACR,WAAO,KAAK;AAAA,EACd;AAAA,EASA,kCAAkC;AAChC,UAAM,SAAS,oBAAI,IAAI;AACvB,UAAM,SAAS,IAAI,SAAS;AAE5B,eAAW,SAAS,KAAK,QAAQ;AAC/B,UAAI,OAAO,CAAC;AACZ,UAAI,YAAY,MAAM,aAAa;AAEnC,UAAI,EAAE,SAAS,SAAS,GAAG;AACzB,oBAAY,GAAG,UAAU,UAAU,UAAU;AAAA,MAC/C;AAEA,aAAO,IAAI,WAAW,KAAK;AAE3B,iBAAW,YAAY,MAAM,eAAe;AAC1C,YAAI,OAAO,UAAU,eAAe,KAAK,MAAM,eAAe,QAAQ,GAAG;AACvE,gBAAM,YAAY,MAAM,cAAc;AAEtC,cAAI,UAAU,YAAY;AACxB,gBAAI,MAAM,UAAU,WAAW;AAE/B,gBAAI,EAAE,SAAS,GAAG,GAAG;AACnB,oBAAM,GAAG,IAAI,UAAU,IAAI;AAAA,YAC7B;AAEA,iBAAK,KAAK,GAAG;AAAA,UACf;AAAA,QACF;AAAA,MACF;AAEA,aAAO,KAAK,OAAO,SAAO,cAAc,GAAG;AAE3C,aAAO,IAAI,WAAW,IAAI;AAAA,IAC5B;AAEA,QAAI;AACJ,QAAI;AACF,eAAS,OAAO,KAAK;AAAA,IACvB,SAAS,OAAP;AACA,UAAI,CAAC,MAAM,QAAQ,WAAW,0BAA0B,GAAG;AACzD,cAAM;AAAA,MACR;AAEA,aAAO;AAAA,IACT;AAEA,WAAO,OACJ,IAAI,eAAa;AAChB,aAAO,OAAO,IAAI,SAAS;AAAA,IAC7B,CAAC,EACA,OAAO,OAAO;AAAA,EACnB;AAAA,EAYA,aAAa,UAAU,SAAS;AAC9B,UAAM,eAAe,KAAK,gCAAgC;AAC1D,QAAI,gBAAgB,MAAM;AACxB,YAAM,IAAI,MAAM,0BAA0B;AAAA,IAC5C;AAEA,cAAU,EAAE,SAAS,WAAW,CAAC,GAAG;AAAA,MAClC,SAAS;AAAA,IACX,CAAC;AAED,QAAI,QAAQ,SAAS;AACnB,mBAAa,QAAQ;AAAA,IACvB;AAEA,eAAW,SAAS,cAAc;AAChC,eAAS,KAAK;AAAA,IAChB;AAAA,EACF;AACF;",
  "names": []
}
